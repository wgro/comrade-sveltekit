generator client {
  provider = "prisma-client"
  output   = "../src/lib/server/db/generated"
}

datasource db {
  provider = "sqlite"
}

model Language {
  id      String @id @default(cuid())
  code    String @unique // ISO 639-1 or 639-3 code (e.g., 'en', 'uk', 'ru')
  name    String // Native name (e.g., 'Українська')
  name_en String // English name (e.g., 'Ukrainian')

  publishers Publisher[]
}

model Publisher {
  id         String   @id @default(cuid())
  name       String
  slug       String   @unique
  type       String // 'rferl' | 'competitor'
  baseUrl    String
  languageId String
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  language Language @relation(fields: [languageId], references: [id])
  feeds    Feed[]
}

model Feed {
  id           String    @id @default(cuid())
  publisherId  String
  name         String
  url          String
  active       Boolean   @default(true)
  lastPolledAt DateTime?
  lastError    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  publisher Publisher @relation(fields: [publisherId], references: [id], onDelete: Cascade)
  stories   Story[]

  @@unique([publisherId, url])
}

model Story {
  id               String    @id @default(cuid())
  feedId           String
  guid             String
  sourceUrl        String
  originalTitle    String
  originalContent  String?
  originalLanguage String
  status           String    @default("pending") // 'pending' | 'fetched' | 'failed'
  errorMessage     String?
  contentType      String    @default("article") // 'article' | 'video' | 'newsletter'
  publishedAt      DateTime?
  author           String?
  imageUrl         String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  feed         Feed          @relation(fields: [feedId], references: [id], onDelete: Cascade)
  translations Translation[]
  summaries    Summary[]

  @@unique([feedId, guid])
  @@index([status])
  @@index([createdAt(sort: Desc)])
}

model Translation {
  id                String    @id @default(cuid())
  storyId           String
  targetLanguage    String    @default("en")
  translatedTitle   String
  translatedContent String?
  status            String    @default("pending") // 'pending' | 'completed' | 'failed'
  errorMessage      String?
  // LLM metadata
  modelName         String?
  tokenCount        Int?
  generatedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  story Story @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([storyId, targetLanguage])
  @@index([status])
}

model Summary {
  id              String    @id @default(cuid())
  storyId         String
  translationId   String? // Optional: link to specific translation
  summarizedTitle String?
  content         String
  status          String    @default("pending") // 'pending' | 'completed' | 'failed'
  errorMessage    String?
  // LLM metadata
  modelName       String?
  tokenCount      Int?
  generatedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  story Story @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([status])
}
